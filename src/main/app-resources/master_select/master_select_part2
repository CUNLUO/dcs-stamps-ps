#master_select > master.date
#[ $? -ne 0 ] && return ${ERR_MASTER_SELECT}
#master_date=`awk 'NR == 12' master.date | awk $'{print $1}'`
master_date=20100415
ciop-log "INFO" "Choose SLC from $master_date as final master"

master=`grep ${master_date} ${TMPDIR}/slc_folders.tmp`

ciop-log "INFO" "Retrieve final master SLC from ${master_date}"
ciop-copy -f -O ${SLC}/ ${master}
	cd ${SLC}/${master_date}
MAS_WIDTH=`grep WIDTH ${master_date}.slc.rsc | awk '{print $2}' `
MAS_LENGTH=`grep FILE_LENGTH ${master_date}.slc.rsc | awk '{print $2}' `

ciop-log "INFO" "Running step_master_setup"
echo "first_l 1" > master_crop.in
echo "last_l $MAS_LENGTH" >> master_crop.in
echo "first_p 1" >> master_crop.in
echo "last_p $MAS_WIDTH" >> master_crop.in
step_master_setup
[ $? -ne 0 ] && return ${ERR_MASTER_SETUP} 

# DEM steps
# getting the original file url for dem fucntion
master_ref=`cat $master_date.url`
ciop-log "INFO" "Prepare DEM with: $master_ref"		
dem ${master_ref} ${TMPDIR}/DEM
[ $? -ne 0 ] && return ${ERR_DEM}

	
head -n 28 ${STAMPS}/DORIS_SCR/timing.dorisin > ${PROCESS}/INSAR_${master_date}/timing.dorisin
cat ${TMPDIR}/DEM/input.doris_dem >> ${PROCESS}/INSAR_${master_date}/timing.dorisin  
tail -n 13 ${STAMPS}/DORIS_SCR/timing.dorisin >> ${PROCESS}/INSAR_${master_date}/timing.dorisin	

cd ${PROCESS}/INSAR_${master_date}/
ciop-log "INFO" "Running step_master_timing"		
step_master_timing
[ $? -ne 0 ] && return ${ERR_MASTER_TIMING}

ciop-log "INFO" "Archiving the newly created INSAR_$master_date folder"
cd ${PROCESS}
tar cvfz INSAR_${master_date}.tgz INSAR_${master_date}
[ $? -ne 0 ] && return ${ERR_INSAR_TAR}

ciop-log "INFO" "Publishing the newly created INSAR_$master_date folder"
insar_master=$( ciop-publish -a ${PROCESS}/INSAR_${master_date}.tgz )
[ $? -ne 0 ] && return ${ERR_INSAR_PUBLISH}

cd ${TMPDIR}
ciop-log "INFO" "Archiving the DEM folder"
tar cvfz DEM.tgz DEM
[ $? -ne 0 ] && return ${ERR_DEM_TAR}

ciop-log "INFO" "Publishing the DEM folder"
dem=$( ciop-publish -a ${TMPDIR}/DEM.tgz )
[ $? -ne 0 ] && return ${ERR_DEM_PUBLISH}
	
for slcs in `cat ${TMPDIR}/slc_folders.tmp`; do
	ciop-log "INFO" "Will publish the final output"
	echo "${insar_master},${slcs},${dem}" | ciop-publish -s	
	[ $? -ne 0 ] && return ${ERR_FINAL_PUBLISH}

done
